<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>som.encryption ‚Äì Secure Photo & Video Sharing</title>

<style>
body{font-family:system-ui;background:#0f172a;color:#e5e7eb;margin:0}
.wrap{max-width:720px;margin:40px auto;padding:24px}
.card{background:#020617;border:1px solid #1f2937;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35);animation:fadeIn .6s ease forwards}
.hidden{display:none}
button,input{width:100%;padding:14px;border-radius:12px;border:1px solid #334155;background:#020617;color:#e5e7eb}
button{background:#2563eb;border:none;font-weight:600;cursor:pointer}
.mt{margin-top:16px}
.code{font-size:1.4rem;letter-spacing:4px;text-align:center;border:1px dashed #334155;padding:14px}
#viewer img,#viewer video{max-width:100%;margin-bottom:12px}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig={
  apiKey:"AIzaSyB0vasTDUqN4ztpiD_gzx0jrfOLEWx9AW0",
  authDomain:"som-encryption.firebaseapp.com",
  projectId:"som-encryption",
  storageBucket:"som-encryption.appspot.com"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const storage=getStorage(app);

const enc=new TextEncoder();

const welcome=document.getElementById("welcome");
const uploadCard=document.getElementById("uploadCard");
const accessCard=document.getElementById("accessCard");
const viewer=document.getElementById("viewer");
const codeBox=document.getElementById("codeBox");
const copyBtn=document.getElementById("copyBtn");
const loader=document.getElementById("loader");
const fileInput=document.getElementById("file");
const accessCode=document.getElementById("accessCode");

/* üîß FIX: expose functions to window */
// make functions global for HTML buttons

window.showUpload = () => {
  welcome.classList.add('hidden');
  uploadCard.classList.remove('hidden');
};

window.showAccess = () => {
  welcome.classList.add('hidden');
  accessCard.classList.remove('hidden');
};

function generateCode(){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(10)))
    .map(x => chars[x % chars.length]).join('');
}

async function deriveKey(code, salt){
  const baseKey = await crypto.subtle.importKey(
    'raw', enc.encode(code), 'PBKDF2', false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    { name:'PBKDF2', salt, iterations:200000, hash:'SHA-256' },
    baseKey,
    { name:'AES-GCM', length:256 },
    false,
    ['encrypt','decrypt']
  );
}

window.encryptAndUpload = async () => {
  loader.classList.remove('hidden');

  const files = fileInput.files;
  if (!files || files.length === 0) {
    loader.classList.add('hidden');
    return alert('Select at least 1 file');
  }

  const zip = new JSZip();
  for (let file of files) zip.file(file.name, file);
  const zipContent = await zip.generateAsync({ type: "uint8array" });

  const code = generateCode();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(code, salt);

  const encrypted = await crypto.subtle.encrypt(
    { name:'AES-GCM', iv }, key, zipContent
  );

  const blob = new Blob([encrypted], { type:"application/octet-stream" });
  const storageRef = ref(storage, "files/" + code + ".enc");
  await uploadBytes(storageRef, blob);

  await setDoc(doc(db, "files", code), {
    salt: btoa(String.fromCharCode(...salt)),
    iv: btoa(String.fromCharCode(...iv)),
    path: "files/" + code + ".enc"
  });

  codeBox.textContent = code;
  codeBox.hidden = false;
  copyBtn.classList.remove('hidden');
  loader.classList.add('hidden');
};

window.copyCode = () => {
  navigator.clipboard.writeText(codeBox.textContent);
  copyBtn.textContent = "Copied ‚úî";
};

window.decryptAndOpen = async () => {
  const codeVal = accessCode.value.trim().toUpperCase();
  const snap = await getDoc(doc(db, "files", codeVal));
  if (!snap.exists()) return alert("Invalid code");

  const data = snap.data();
  const salt = Uint8Array.from(atob(data.salt), c => c.charCodeAt(0));
  const iv = Uint8Array.from(atob(data.iv), c => c.charCodeAt(0));

  const url = await getDownloadURL(ref(storage, data.path));
  const resp = await fetch(url);
  const encryptedData = new Uint8Array(await resp.arrayBuffer());

  const key = await deriveKey(codeVal, salt);
  const decrypted = await crypto.subtle.decrypt(
    { name:'AES-GCM', iv }, key, encryptedData
  );

  const zip = await JSZip.loadAsync(decrypted);
  viewer.innerHTML = "";

  for (let filename of Object.keys(zip.files)) {
    const fileData = await zip.files[filename].async("blob");

    if (fileData.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(fileData);
      viewer.appendChild(img);
    } 
    else if (fileData.type.startsWith("video/")) {
      const vid = document.createElement("video");
      vid.src = URL.createObjectURL(fileData);
      vid.controls = true;
      viewer.appendChild(vid);
    }
  }
};

</script>
</head>

<body>
<div class="wrap">

<div class="card" id="welcome">
<h2>üîê som.encryption</h2>
<button class="mt" onclick="showUpload()">Upload</button>
<button class="mt" onclick="showAccess()">Access</button>
</div>

<div class="card hidden" id="uploadCard">
<input type="file" id="file" multiple>
<button class="mt" onclick="encryptAndUpload()">Generate Code</button>
<div id="loader" class="mt hidden">Encrypting...</div>
<div id="codeBox" class="mt code" hidden></div>
<button id="copyBtn" class="mt hidden" onclick="copyCode()">Copy</button>
</div>

<div class="card hidden" id="accessCard">
<input id="accessCode" placeholder="Enter code">
<button class="mt" onclick="decryptAndOpen()">Access</button>
<div id="viewer" class="mt"></div>
</div>

</div>
</body>
</html>

