<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>som.encryption ‚Äì Secure Photo & Video Sharing</title>

<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0f172a;color:#e5e7eb;margin:0}
.wrap{max-width:720px;margin:40px auto;padding:24px}
.card{background:#020617;border:1px solid #1f2937;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;animation:fadeIn .6s ease forwards}
h1{font-size:1.7rem;margin:0 0 8px}
p{color:#9ca3af}
input,button{width:100%;padding:14px;border-radius:12px;border:1px solid #334155;background:#020617;color:#e5e7eb}
button{background:#2563eb;border:none;font-weight:600;cursor:pointer}
button.secondary{background:#020617;border:1px solid #334155}
.mt{margin-top:16px}
.code{font-size:1.4rem;letter-spacing:4px;text-align:center;border:1px dashed #334155;padding:14px;border-radius:12px}
.hidden{display:none}
#viewer img,#viewer video{max-width:100%;margin-bottom:12px}
#loader{text-align:center;color:#60a5fa}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB0vasTDUqN4ztpiD_gzx0jrfOLEWx9AW0",
  authDomain: "som-encryption.firebaseapp.com",
  projectId: "som-encryption",
  storageBucket: "som-encryption.appspot.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const enc = new TextEncoder();

const welcome = document.getElementById('welcome');
const uploadCard = document.getElementById('uploadCard');
const accessCard = document.getElementById('accessCard');
const viewer = document.getElementById('viewer');
const codeBox = document.getElementById('codeBox');
const copyBtn = document.getElementById('copyBtn');
const loader = document.getElementById('loader');
const fileInput = document.getElementById('file');
const accessCode = document.getElementById('accessCode');

window.showUpload = ()=>{welcome.classList.add('hidden');uploadCard.classList.remove('hidden')}
window.showAccess = ()=>{welcome.classList.add('hidden');accessCard.classList.remove('hidden')}

function generateCode(){
 const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
 return Array.from(crypto.getRandomValues(new Uint8Array(10))).map(x=>c[x%c.length]).join('')
}

async function deriveKey(code,salt){
 const base=await crypto.subtle.importKey('raw',enc.encode(code),'PBKDF2',false,['deriveKey'])
 return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},base,{name:'AES-GCM',length:256},false,['encrypt','decrypt'])
}

window.encryptAndUpload = async ()=>{
 try{
  loader.classList.remove('hidden')
  const files=fileInput.files
  if(!files.length){loader.classList.add('hidden');alert('Select file');return}

  const zip=new JSZip()
  for(let f of files)zip.file(f.name,f)
  const zipData=await zip.generateAsync({type:'uint8array'})

  const code=generateCode()
  const salt=crypto.getRandomValues(new Uint8Array(16))
  const iv=crypto.getRandomValues(new Uint8Array(12))
  const key=await deriveKey(code,salt)

  const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,zipData)
  const blob=new Blob([encrypted])
  const path=`files/${code}.enc`

  await uploadBytes(ref(storage,path),blob)
  await setDoc(doc(db,'files',code),{salt:btoa(String.fromCharCode(...salt)),iv:btoa(String.fromCharCode(...iv)),path})

  codeBox.textContent=code
  codeBox.hidden=false
  copyBtn.classList.remove('hidden')
  loader.classList.add('hidden')
 }catch(e){loader.classList.add('hidden');alert(e.message)}
}

window.copyCode=()=>{navigator.clipboard.writeText(codeBox.textContent)}

window.decryptAndOpen=async()=>{
 try{
  const code=accessCode.value.trim().toUpperCase()
  const snap=await getDoc(doc(db,'files',code))
  if(!snap.exists()){alert('Invalid code');return}

  const d=snap.data()
  const salt=Uint8Array.from(atob(d.salt),c=>c.charCodeAt(0))
  const iv=Uint8Array.from(atob(d.iv),c=>c.charCodeAt(0))
  const url=await getDownloadURL(ref(storage,d.path))
  const encData=new Uint8Array(await (await fetch(url)).arrayBuffer())

  const key=await deriveKey(code,salt)
  const dec=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,encData)

  const zip=await JSZip.loadAsync(dec)
  viewer.innerHTML=''

  for(let n in zip.files){
    const b=await zip.files[n].async('blob')
    if(b.type.startsWith('image/')){const i=document.createElement('img');i.src=URL.createObjectURL(b);viewer.appendChild(i)}
    else if(b.type.startsWith('video/')){const v=document.createElement('video');v.src=URL.createObjectURL(b);v.controls=true;viewer.appendChild(v)}
  }
 }catch(e){alert(e.message)}
}
</script>
</head>

<body>
<div class="wrap">

<div class="card" id="welcome">
<h1>üîê som.encryption</h1>
<p>Securely share photos & videos with end‚Äëto‚Äëend encryption. No login. No tracking.</p>
<button class="mt" onclick="showUpload()">Upload</button>
<button class="mt secondary" onclick="showAccess()">Access</button>
</div>

<div class="card hidden" id="uploadCard">
<h1>Upload</h1>
<input type="file" id="file" multiple accept="image/*,video/*">
<button class="mt" onclick="encryptAndUpload()">Generate Code</button>
<div class="mt hidden" id="loader">Encrypting‚Ä¶</div>
<div class="mt code hidden" id="codeBox"></div>
<button class="mt secondary hidden" id="copyBtn" onclick="copyCode()">Copy Code</button>
</div>

<div class="card hidden" id="accessCard">
<h1>Access</h1>
<input type="text" id="accessCode" placeholder="Enter Code">
<button class="mt" onclick="decryptAndOpen()">Access</button>
<div class="mt" id="viewer"></div>
</div>

</div>
</body>
</html>

